<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

    <title>AiChat</title>

    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #e0e1e9; /* Ghost White 500 tint */
        }

        #ComposeApp {
            margin-top: env(safe-area-inset-top);
            margin-bottom: env(safe-area-inset-bottom);
            margin-left: env(safe-area-inset-left);
            margin-right: env(safe-area-inset-right);
            height: calc(100% - env(safe-area-inset-top));
            width: calc(100% - env(safe-area-inset-left) - env(safe-area-inset-right));
        }
    </style>

</head>
<body>
<div id="ComposeApp"></div>

<script type="application/javascript">
    const unhandledError = (event, error) => {
        if (error instanceof WebAssembly.CompileError) {
            document.getElementById("warning").style.display = "initial";

            // Hide a Scary Webpack Overlay which is less informative in this case.
            const webpackOverlay = document.getElementById("webpack-dev-server-client-overlay");
            if (webpackOverlay != null) webpackOverlay.style.display = "none";
        }
    }
    addEventListener("error", (event) => unhandledError(event, event.error));
    addEventListener("unhandledrejection", (event) => unhandledError(event, event.reason));
</script>

<script type="application/javascript">
    const body = document.body;
    const warningDiv = document.getElementById("warning"); // Get the warning div

    /*
    Represents the next Wasm module:
    (module
      (type $type0 (struct (field $field0 i8))) ;; GC support
      (func $func0 (try catch_all end))        ;; Exception Handling support
      (func $func1 (ref.null func) (drop))     ;; Function References support
    )
    */
    const featureTestWasmModule = new Uint8Array([
        0, 97, 115, 109, 1, 0, 0, 0, 1, 8, 2, 95,
        1, 120, 0, 96, 0, 0, 3, 3, 2, 1, 1, 10,
        14, 2, 6, 0, 6, 64, 25, 11, 11, 5, 0, 208,
        112, 26, 11, 0, 45, 4, 110, 97, 109, 101, 1, 15,
        2, 0, 5, 102, 117, 110, 99, 48, 1, 5, 102, 117,
        110, 99, 49, 4, 8, 1, 0, 5, 116, 121, 112, 101,
        48, 10, 11, 1, 0, 1, 0, 6, 102, 105, 101, 108,
        100, 48
    ]);

    function checkWasmFeatures() {
        if (typeof WebAssembly === "undefined" || typeof WebAssembly.compile !== "function") {
            return false;
        }
        try {
            console.log("Checking WASM features...");
            // Attempt to compile the module. This WILL throw on unsupported features.
            new WebAssembly.Module(featureTestWasmModule);
            console.log("Required WASM features are supported.");
            return true;
        } catch (error) {
            console.error("WASM feature check failed:", error);
            // We can now safely show our warning message.
            if (warningDiv) {
                warningDiv.style.display = "block";
            }
            // Also hide the webpack overlay if it exists
            const webpackOverlay = document.getElementById("webpack-dev-server-client-overlay");
            if (webpackOverlay) webpackOverlay.style.display = "none";

            return false;
        }
    }

    const createScript = (src) => {
        const script = document.createElement("script");
        script.src = src;
        script.type = "application/javascript";
        script.async = false; // Important for loading scripts in order
        return script;
    };

    if (checkWasmFeatures()) {
        body.appendChild(createScript("kotlin-app-wasm-js.js"));
    } else {
        // Fallback for browsers without WASM GC/EH support
        body.appendChild(createScript("skiko.js"));
        body.appendChild(createScript("kotlin-app-js.js"));
    }
</script>

</body>
</html>